<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Filmer CRUD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

<div class="container py-4">
  <h1 class="mb-4">Filmer CRUD</h1>

  <form id="filmForm" class="mb-4">
    <input type="hidden" id="filmId" />
    <div class="mb-3">
      <label for="titel" class="form-label">Titel</label>
      <input type="text" class="form-control" id="titel" required />
    </div>
    <div class="mb-3">
      <label for="år" class="form-label">År</label>
      <input type="number" class="form-control" id="år" />
    </div>
    <div class="mb-3">
      <label for="genre" class="form-label">Genre</label>
      <input type="text" class="form-control" id="genre" />
    </div>
    <div class="mb-3">
      <label for="betyg" class="form-label">Betyg</label>
      <input type="number" class="form-control" id="betyg" min="1" max="10" />
    </div>
    <button type="submit" class="btn btn-primary">Spara</button>
    <button type="button" id="rensaBtn" class="btn btn-secondary ms-2">Rensa</button>
  </form>

  <div id="meddelande" class="alert d-none"></div>

  <div id="filmerList" class="row g-3"></div>
</div>

<script>
  const filmForm = document.getElementById('filmForm');
  const filmerList = document.getElementById('filmerList');
  const meddelande = document.getElementById('meddelande');
  const rensaBtn = document.getElementById('rensaBtn');

  function visaMeddelande(text, typ = 'success') {
    meddelande.textContent = text;
    meddelande.className = 'alert alert-' + typ;
    meddelande.classList.remove('d-none');
    setTimeout(() => meddelande.classList.add('d-none'), 3000);
  }

  function hamtaFilmer() {
    fetch('/filmer')
      .then(res => res.json())
      .then(data => {
        filmerList.innerHTML = '';
        data.forEach(film => {
          const card = document.createElement('div');
          card.className = 'col-md-4';
          card.innerHTML = `
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">${film.titel}</h5>
                <p class="card-text">År: ${film.år || '-'}</p>
                <p class="card-text">Genre: ${film.genre || '-'}</p>
                <p class="card-text">Betyg: ${film.betyg || '-'}</p>
                <button class="btn btn-sm btn-warning me-2" onclick="editFilm(${film.id})">Redigera</button>
                <button class="btn btn-sm btn-danger" onclick="taBortFilm(${film.id})">Ta bort</button>
              </div>
            </div>
          `;
          filmerList.appendChild(card);
        });
      });
  }

  function editFilm(id) {
    fetch('/filmer/' + id)
      .then(res => res.json())
      .then(film => {
        document.getElementById('filmId').value = film.id;
        document.getElementById('titel').value = film.titel;
        document.getElementById('år').value = film.år || '';
        document.getElementById('genre').value = film.genre || '';
        document.getElementById('betyg').value = film.betyg || '';
      });
  }

  function taBortFilm(id) {
    if (!confirm('Vill du ta bort denna film?')) return;
    fetch('/filmer/' + id, { method: 'DELETE' })
      .then(res => res.json())
      .then(data => {
        visaMeddelande(data.message, 'success');
        hamtaFilmer();
        rensaForm();
      });
  }

  function rensaForm() {
    filmForm.reset();
    document.getElementById('filmId').value = '';
  }

  filmForm.addEventListener('submit', e => {
    e.preventDefault();
    const id = document.getElementById('filmId').value;
    const titel = document.getElementById('titel').value.trim();
    const år = parseInt(document.getElementById('år').value);
    const genre = document.getElementById('genre').value.trim();
    const betyg = parseInt(document.getElementById('betyg').value);

    const filmData = { titel, år: isNaN(år) ? null : år, genre, betyg: isNaN(betyg) ? null : betyg };

    if (id) {
      filmData.id = parseInt(id);
      fetch('/filmer', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(filmData)
      })
        .then(res => res.json())
        .then(data => {
          visaMeddelande(data.message, data.error ? 'danger' : 'success');
          hamtaFilmer();
          rensaForm();
        });
    } else {
      fetch('/filmer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(filmData)
      })
        .then(res => res.json())
        .then(data => {
          visaMeddelande(data.message, data.error ? 'danger' : 'success');
          hamtaFilmer();
          rensaForm();
        });
    }
  });

  rensaBtn.addEventListener('click', rensaForm);

  hamtaFilmer();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>